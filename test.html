<!DOCTYPE html>
<html lang='en'>
<head>
<title>Boxmatic</title>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<link rel='stylesheet' href='resources/css/bootstrap.min.css'>
<link rel='stylesheet' href='resources/css/bootstrap-theme.min.css'>

<script src="resources/js/lightgl.js"></script>
<script src="csg.js"></script>
<script src="openjscad.js"></script>
<script src="resources/js/aminoinput.js"></script>
<script src="resources/js/amino.js"></script>
<script src="resources/js/widgets.js"></script>
<script src="resources/js/canvasamino.js"></script>
<script src="resources/js/jquery-2.0.3.min.js"></script>
<script src='resources/js/bootstrap.min.js'></script>

<style type='text/css'>
canvas { border: 1px solid black; }
</style>
</head>
<body>

<div class='container'>

<h1>Boxmatic</h1>


<div class='row'>
<h3 class='col-md-6'>Side editor</h3>
<h3 class='col-md-6'>3D view</h3>
</div>


<div class='row'>
<div class='col-md-6'>
<canvas id='editor' width=300 height=300></canvas>
</div>
<div class='col-md-6'>
<div id='viewer'></div>
</div>
</div>

<div class='row'>
<div class='col-md-12'>
<div class='btn-group'>
<button type='button' class='btn btn-default'>Recenter flat</button>
<button type='button' class='btn btn-default'>Recenter angle</button>
</div>
<div class='btn-group'>
<button type='button' class='btn btn-default'>Recenter flat</button>
<button type='button' class='btn btn-default'>Recenter angle</button>
</div>
</div>
</div>

</div>


<script>
var gProcessor=null;

// Show all exceptions to the user:
OpenJsCad.AlertUserOfUncaughtExceptions();
var params = {
    rect1: {
        tx: 0,
        ty: 0,
        rx:  5
    },
    rect2: {
        tx: 0,
        ty: 0,
    },
}

function onload() {
    console.log("onloading");
    
    var options = {
        viewerwidth:400,
        viewerheight:300,
    };
    
    gProcessor = new OpenJsCad.Processor(
        document.getElementById("viewer"),
        function() {
            console.log("changed");
        }
        ,options
    );
    updateSolid();
    
    setupAmino();
}

function updateSolid() {
    var text = document.getElementById('code').text;
    text = text.replace(/@@rect1xoff@@/,''+params.rect1.tx);
    text = text.replace(/@@rect1yoff@@/,''+params.rect1.ty);
    text = text.replace(/@@rect2xoff@@/,''+params.rect2.tx);
    text = text.replace(/@@rect2yoff@@/,''+params.rect2.ty);
    gProcessor.setJsCad(text);
}


function setupAmino() {
    console.log("setting up amino");
    amino.setCanvas("editor");
    amino.startApp(function(core,stage) {
        console.log("starting");
        
        var root = new amino.ProtoGroup();
        stage.setRoot(root);


        var body = new amino.ProtoRect().setW(80).setH(60).setFill("#0000ff")
            .setScalex(2.0).setScaley(2.0)
        ;
        root.add(body);
        
        var dragfunc = function(e) {
        console.log('dragging');
            e.target.setTx(e.target.getTx()+e.dx);
            e.target.setTy(e.target.getTy()+e.dy);
        };

        var rect = new amino.ProtoRect().setW(20).setH(10).setTx(0).setTy(0);
        root.add(rect);
        core.on("drag",rect,dragfunc);
        
        var rect2 = new amino.ProtoRect().setW(10).setH(30).setFill("#00ff00");
        core.on('drag',rect2,dragfunc);
        root.add(rect2);
        
        
        core.on("release",rect,function(e) {
            params.rect1.tx= rect.getTx()/2 - 40 + 10;
            params.rect1.ty = 60/2-rect.getTy()/2-5;
            updateSolid();
        });
        core.on("release",rect2,function(e) {
            params.rect2.tx = rect2.getTx()/2 - 40 + 10;
            params.rect2.ty = 60/2-rect2.getTy()/2-5;
            updateSolid();
        });
        
    });
}

$(document).ready(onload);
</script>

<script language="template" id="code">
function main() {
    var thick = 1; 
    var width = 40;
    var depth = 30;
    var height = 30;
    var rect1xoff = @@rect1xoff@@;
    var rect1yoff = @@rect1yoff@@;
    var rect2xoff = @@rect2xoff@@;
    var rect2yoff = @@rect2yoff@@;
    
    var cube = CSG.cube({
        radius:[width,depth,height]
    }); 
  
    var inside = CSG.cube({
        center:[0,0,thick],
        radius:[width-thick,depth-thick,height-thick]
    });
    
    var base = cube.subtract(inside);
    
    //rounded edges
    //base = base.expand(2,8);
    
    
    //front face
    
    // cut out a circle
    var cutout = CAG.circle({center:[0,0], radius: 4, resolution: 20});
    var cutout2 = cutout.extrudeInPlane("-Z","X",10).translate([0,-depth,0]);
    //base = base.subtract(cutout2);
    
    //cut out a rectangle
    var square = CAG.rectangle({center:[0,0], radius:[5,10]})
        .extrudeInPlane("-Z","X",10)
        .translate([0,-depth,0])
        .translate([rect1xoff,0,rect1yoff])
        ;
    base = base.subtract(square);
    
    var square2 = CAG.rectangle({center:[0,0], radius:[15,5]})
        .extrudeInPlane("-Z","X",10)
        .translate([0,-depth,0])
        .translate([rect2xoff,0,rect2yoff])
        ;
    base = base.subtract(square2);
    
    return base;
}

</script>

</body>
</html>
